version: '3.4'

services:

  mysql_server:
    build: ./database/
    image: denishuaman/mysql_ventas:latest
    # ports:
    #   - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=ventas
      - MYSQL_USER=app
      - MYSQL_PASSWORD=root
      - MYSQL_ROOT_HOST=%
    volumes:
      - my-data-mysql:/var/lib/mysql
    restart: on-failure
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - backend

  apiventa:
    build: ./apiVenta/
    image: denishuaman/api-venta:latest
    # ports:
    #   - "8082:8082"
    environment:
      - hostapi=http://apipersona:8081
      - host=mysql_server
      - port=3306
      - database=ventas
      - username=root
      - password=root
    depends_on:
      - mysql_server
    restart: on-failure
    entrypoint: dockerize -wait tcp://mysql_server:3306 -timeout 10m java -jar /app.jar
    networks:
      - backend

  apipersona:
    build: ./apiPersona/
    image: denishuaman/api-persona:latest
    # ports:
    #   - "8081:8081"
    environment:
      - host=mysql_server
      - port=3306
      - database=ventas
      - username=root
      - password=root
    depends_on:
      - mysql_server
    restart: on-failure
    entrypoint: dockerize -wait tcp://mysql_server:3306 -timeout 10m java -jar /app.jar
    networks:
      - backend

  proxy:
    build: ./proxy-backend/
    image: denishuaman/proxy-venta:latest
    ports:
      - "80:80"
    depends_on: 
      - apipersona
      - apiventa
    restart: on-failure
    networks:
      - backend

volumes:
  my-data-mysql:
networks:
  backend: